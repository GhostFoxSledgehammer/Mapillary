#!/usr/bin/env bash
set -e

echo "branch $TRAVIS_BRANCH | JDK $TRAVIS_JDK_VERSION | PR #$TRAVIS_PULL_REQUEST | Publish gh-pages? $PUBLISH_GH_PAGES"

if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_JDK_VERSION" == "openjdk8" ] && [ "$TRAVIS_PULL_REQUEST" = false ] && [ "$PUBLISH_GH_PAGES" = true ]; then
  mainDir=`pwd`
  pagesDir=`readlink -f ../gh-pages`
  masterCommit=`git rev-parse master`

  git config --global user.email "deploy@travis"
  git config --global user.name "Travis CI"

  # Prevent printout of credentials
  git config --global credential.helper store
  echo "https://${GH_USERNAME}:${GH_TOKEN}@github.com" > $HOME/.git-credentials


  git clone --depth=1 --branch=gh-pages "https://github.com/JOSM/Mapillary.git" "$pagesDir"
  cd "$pagesDir"
  git rm -r "*"
  mkdir -p reports/ docs/
  cp -TR $mainDir/gh-pages .
  cp -R "$mainDir/build/docs/javadoc/" docs/javadoc/
  cp -R "$mainDir/build/reports/tests/" reports/junit/
  cp -R "$mainDir/build/reports/jacoco/" reports/jacoco/
  cp -R "$mainDir/build/reports/spotbugs/" reports/spotbugs/
  cp -R "$mainDir/build/reports/pmd/" reports/pmd/
  git stage --all
  git commit -m "Publish developer resources to GitHub pages

These resources are generated by Travis CI for commit $masterCommit using Gradle."
  git push origin gh-pages
fi
