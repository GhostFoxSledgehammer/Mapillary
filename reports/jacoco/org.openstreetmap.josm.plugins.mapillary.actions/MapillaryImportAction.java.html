<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MapillaryImportAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mapillary</a> &gt; <a href="index.source.html" class="el_package">org.openstreetmap.josm.plugins.mapillary.actions</a> &gt; <span class="el_source">MapillaryImportAction.java</span></div><h1>MapillaryImportAction.java</h1><pre class="source lang-java linenums">// License: GPL. For details, see LICENSE file.
package org.openstreetmap.josm.plugins.mapillary.actions;

import static org.openstreetmap.josm.tools.I18n.tr;

import java.awt.event.ActionEvent;
import java.awt.event.KeyEvent;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ConcurrentSkipListSet;

import javax.swing.JFileChooser;

import org.openstreetmap.josm.Main;
import org.openstreetmap.josm.actions.JosmAction;
import org.openstreetmap.josm.plugins.mapillary.MapillaryAbstractImage;
import org.openstreetmap.josm.plugins.mapillary.MapillaryPlugin;
import org.openstreetmap.josm.plugins.mapillary.history.MapillaryRecord;
import org.openstreetmap.josm.plugins.mapillary.history.commands.CommandImport;
import org.openstreetmap.josm.plugins.mapillary.utils.ImageUtil;
import org.openstreetmap.josm.plugins.mapillary.utils.MapillaryProperties;
import org.openstreetmap.josm.plugins.mapillary.utils.MapillaryUtils;
import org.openstreetmap.josm.tools.Shortcut;

/**
 * Imports a set of picture files into JOSM. They must be in jpg or png format.
 *
 * @author nokutu
 *
 */
public class MapillaryImportAction extends JosmAction {
  private static final long serialVersionUID = 4086660991261961490L;

  public MapillaryImportAction() {
<span class="fc" id="L37">    this(</span>
<span class="fc" id="L38">      tr(&quot;Import pictures&quot;),</span>
<span class="fc" id="L39">      tr(&quot;Import local pictures&quot;),</span>
      &quot;Import Mapillary&quot;,
<span class="fc" id="L41">      tr(&quot;Import pictures into Mapillary layer&quot;),</span>
      &quot;mapillaryImport&quot;
    );
<span class="fc" id="L44">  }</span>

  /**
   * Convenience constructor, which calls the super-constructor and disables the action.
   * @param name the name of the {@link JosmAction}, as displayed in the menu
   * @param tooltip a longer description of the {@link JosmAction}, that is displayed as tooltip
   * @param shortcutId an ID for the {@link Shortcut} as described in
   *   {@link Shortcut#registerShortcut(String, String, int, int)} (the passage about the second parameter)
   * @param shortcutName a name for the shortcut (displayed to the user, so use a self-explanatory and translated
   *   {@link String}). See the description of the second parameter in
   *   {@link Shortcut#registerShortcut(String, String, int, int)}
   * @param toolbarId identifier for the toolbar preferences
   * @see JosmAction#JosmAction(String, String, String, Shortcut, boolean, String, boolean)
   * @see Shortcut#registerShortcut(String, String, int, int)
   */
  protected MapillaryImportAction(
    String name, String tooltip, String shortcutId, String shortcutName, String toolbarId
  ) {
<span class="fc" id="L62">    super(</span>
      name,
<span class="fc" id="L64">      MapillaryPlugin.getProvider(&quot;icon24.png&quot;),</span>
      tooltip,
<span class="fc" id="L66">      Shortcut.registerShortcut(shortcutId, shortcutName, KeyEvent.CHAR_UNDEFINED, Shortcut.NONE),</span>
      false,
      toolbarId,
      false
    );
<span class="fc" id="L71">    setEnabled(false);</span>
<span class="fc" id="L72">  }</span>

  /**
   * Shows the {@link JFileChooser} for selecting images and loads the chosen images into a {@link List}.
   * @return A {@link List} containing the loaded {@link MapillaryAbstractImage}s (might be empty but never null).
   */
  public List&lt;MapillaryAbstractImage&gt; chooseImages() {
<span class="nc" id="L79">    final JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L80">    chooser.setCurrentDirectory(new File(MapillaryProperties.START_DIR.get()));</span>
<span class="nc" id="L81">    chooser.setDialogTitle(tr(&quot;Select pictures&quot;));</span>
<span class="nc" id="L82">    chooser.setFileSelectionMode(JFileChooser.FILES_AND_DIRECTORIES);</span>
<span class="nc" id="L83">    chooser.setAcceptAllFileFilterUsed(false);</span>
<span class="nc" id="L84">    chooser.addChoosableFileFilter(ImageUtil.IMAGE_FILE_FILTER);</span>
<span class="nc" id="L85">    chooser.setMultiSelectionEnabled(true);</span>

<span class="nc" id="L87">    final List&lt;MapillaryAbstractImage&gt; images = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">    if (chooser.showOpenDialog(Main.parent) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">      for (File file : chooser.getSelectedFiles()) {</span>
        try {
<span class="nc" id="L92">          images.addAll(ImageUtil.readImagesFrom(</span>
              file,
<span class="nc" id="L94">              Main.map.mapView.getProjection().eastNorth2latlon(Main.map.mapView.getCenter())</span>
          ));
<span class="nc" id="L96">        } catch (IOException e) {</span>
<span class="nc" id="L97">          Main.error(&quot;Could not read image(s) from &quot;+file.getAbsolutePath());</span>
<span class="nc" id="L98">        }</span>
      }
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (chooser.getSelectedFiles().length &gt;= 1) {</span>
<span class="nc" id="L101">        final File lastSelectedFile = chooser.getSelectedFiles()[chooser.getSelectedFiles().length - 1];</span>
<span class="nc" id="L102">        MapillaryProperties.START_DIR.put(</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">          lastSelectedFile.getParent() == null ? lastSelectedFile.getAbsolutePath() : lastSelectedFile.getParent()</span>
        );
      }
    }
<span class="nc" id="L107">    return images;</span>
  }

  /**
   * Records in the history, that the given images were loaded
   * @param addedImages the images that have been loaded
   */
  public void recordChanges(List&lt;MapillaryAbstractImage&gt; addedImages) {
<span class="nc" id="L115">    MapillaryRecord.getInstance().addCommand(new CommandImport(new ConcurrentSkipListSet&lt;&gt;(addedImages)));</span>
<span class="nc" id="L116">    MapillaryUtils.showAllPictures();</span>
<span class="nc" id="L117">  }</span>

  @Override
  public void actionPerformed(ActionEvent event) {
<span class="nc" id="L121">    recordChanges(chooseImages());</span>
<span class="nc" id="L122">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201611140741</span></div></body></html>